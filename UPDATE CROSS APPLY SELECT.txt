-- DECLARAR UMA TABELA PARA GERAR REGISTROS COM TODOS OS POSTOS COM SEU COLETE CORRESPONDENTE.
DECLARE @TBPOSTOS TABLE (
	NUMEROSERIE VARCHAR(20),
	POSTOANTIGO INT,
	POSTONOVO INT,
    SEQUENCIA INT,
    INSUMOEMPRESA INT,
    NECESSIDADESINSUMOSANTIGA INT,
    ALOCACAOINSUMOS INT,
    NECESSIDADESINSUMOSNOVO INT);

INSERT INTO @TBPOSTOS (NUMEROSERIE, POSTOANTIGO, POSTONOVO) VALUES ('150110024', 296406, 324422);
INSERT INTO @TBPOSTOS (NUMEROSERIE, POSTOANTIGO, POSTONOVO) VALUES ('150110025', 296406, 324422);
INSERT INTO @TBPOSTOS (NUMEROSERIE, POSTOANTIGO, POSTONOVO) VALUES ('130080370', 296413, 324429);
INSERT INTO @TBPOSTOS (NUMEROSERIE, POSTOANTIGO, POSTONOVO) VALUES ('394807', 296413, 324429);
INSERT INTO @TBPOSTOS (NUMEROSERIE, POSTOANTIGO, POSTONOVO) VALUES ('130069483', 296413, 324429);
INSERT INTO @TBPOSTOS (NUMEROSERIE, POSTOANTIGO, POSTONOVO) VALUES ('271454', 296407, 324423);
INSERT INTO @TBPOSTOS (NUMEROSERIE, POSTOANTIGO, POSTONOVO) VALUES ('271457', 296407, 324423);
INSERT INTO @TBPOSTOS (NUMEROSERIE, POSTOANTIGO, POSTONOVO) VALUES ('130069504', 296407, 324423);
INSERT INTO @TBPOSTOS (NUMEROSERIE, POSTOANTIGO, POSTONOVO) VALUES ('3948216', 296410, 324426);
INSERT INTO @TBPOSTOS (NUMEROSERIE, POSTOANTIGO, POSTONOVO) VALUES ('150110028', 296410, 324426);
INSERT INTO @TBPOSTOS (NUMEROSERIE, POSTOANTIGO, POSTONOVO) VALUES ('150110030', 296410, 324426);
INSERT INTO @TBPOSTOS (NUMEROSERIE, POSTOANTIGO, POSTONOVO) VALUES ('150110054', 296410, 324426);
INSERT INTO @TBPOSTOS (NUMEROSERIE, POSTOANTIGO, POSTONOVO) VALUES ('394826', 296408, 324424);
INSERT INTO @TBPOSTOS (NUMEROSERIE, POSTOANTIGO, POSTONOVO) VALUES ('150110060', 296408, 324424);
INSERT INTO @TBPOSTOS (NUMEROSERIE, POSTOANTIGO, POSTONOVO) VALUES ('150110041', 296420, 324436);
INSERT INTO @TBPOSTOS (NUMEROSERIE, POSTOANTIGO, POSTONOVO) VALUES ('150110055', 296411, 324427);
INSERT INTO @TBPOSTOS (NUMEROSERIE, POSTOANTIGO, POSTONOVO) VALUES ('150110034', 296414, 324430);
INSERT INTO @TBPOSTOS (NUMEROSERIE, POSTOANTIGO, POSTONOVO) VALUES ('271425', 296414, 324430);
INSERT INTO @TBPOSTOS (NUMEROSERIE, POSTOANTIGO, POSTONOVO) VALUES ('271421', 296418, 324434);
INSERT INTO @TBPOSTOS (NUMEROSERIE, POSTOANTIGO, POSTONOVO) VALUES ('271455', 296418, 324434);

UPDATE X
SET    X.SEQUENCIA = P.SEQUENCIA,
       X.INSUMOEMPRESA = P.INSUMOEMPRESA,
	   X.NECESSIDADESINSUMOSANTIGA = P.NECESSIDADESINSUMOS,
	   X.ALOCACAOINSUMOS = P.ALOCACAOINSUMOS
FROM @TBPOSTOS X
CROSS APPLY
	(SELECT IC.SEQUENCIA, NI.INSUMOEMPRESA, NI.NECESSIDADESINSUMOS, NI.ALOCACAOINSUMOS --, CIC.ITENSCONTRATO --, NI.*
	FROM   NECESSIDADESINSUMOS NI
	INNER JOIN COMPOSICAOITENSCONTRATO CIC ON CIC.COMPOSICAOITENSCONTRATO = NI.COMPOSICAOITENSCONTRATO
	INNER JOIN ITENSCONTRATO IC ON IC.ITENSCONTRATO = CIC.ITENSCONTRATO

	INNER JOIN INSUMOEMPRESA (NOLOCK) IE ON (NI.INSUMOEMPRESA = IE.INSUMOEMPRESA)
	INNER JOIN ALOCACAOINSUMOS (NOLOCK) AI ON (NI.NECESSIDADESINSUMOS = AI.NECESSIDADESINSUMOS)
	INNER JOIN ESTOQUEINSUMO (NOLOCK) EI ON (AI.ESTOQUEINSUMO = EI.ESTOQUEINSUMO)
	WHERE  1 = 1
	AND   EI.NUMEROSERIE = X.NUMEROSERIE	
	AND   NI.POSTO = X.POSTOANTIGO) AS P;

UPDATE X
SET    X.NECESSIDADESINSUMOSNOVO = P.NECESSIDADESINSUMOS
FROM   @TBPOSTOS X
CROSS APPLY
	(SELECT NI.NECESSIDADESINSUMOS
	FROM   NECESSIDADESINSUMOS NI
	INNER JOIN COMPOSICAOITENSCONTRATO CIC ON CIC.COMPOSICAOITENSCONTRATO = NI.COMPOSICAOITENSCONTRATO
	INNER JOIN ITENSCONTRATO IC ON IC.ITENSCONTRATO = CIC.ITENSCONTRATO
	WHERE  1 = 1
	AND    NI.POSTO = X.POSTONOVO
	AND    NI.INSUMOEMPRESA = X.INSUMOEMPRESA	
	AND    IC.SEQUENCIA = X.SEQUENCIA
	AND    NI.ALOCACAOINSUMOS IS NULL) AS P;


SELECT * FROM @TBPOSTOS;
